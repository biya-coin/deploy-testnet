---
# ==========================================
# 任务模块：配置 P2P 连接（persistent_peers）
# ==========================================
# 功能：根据本地生成的 node_id.txt 配置 persistent_peers
# ==========================================

- name: 显示 P2P 连接配置信息
  debug:
    msg: |
      开始配置 P2P 连接
      - 当前节点: {{ node_type }}-{{ node_index }}
  tags: ['config', 'peers']

# ------------------------------------------
# 从本地配置目录读取所有节点的 node_id
# ------------------------------------------
- name: 收集所有节点的 node_id（从本地配置）
  set_fact:
    all_peers: []
  delegate_to: localhost
  run_once: true
  tags: ['config', 'peers']

- name: 读取所有 validator 节点的 node_id
  shell: |
    if [ -f "{{ local_config_dir }}/{{ item }}/node_id.txt" ]; then
      cat "{{ local_config_dir }}/{{ item }}/node_id.txt"
    fi
  register: validator_node_ids
  delegate_to: localhost
  loop: "{{ groups['all'] | select('match', '^validator-.*') | list }}"
  changed_when: false
  failed_when: false
  tags: ['config', 'peers']

- name: 读取所有 sentry 节点的 node_id
  shell: |
    if [ -f "{{ local_config_dir }}/{{ item }}/node_id.txt" ]; then
      cat "{{ local_config_dir }}/{{ item }}/node_id.txt"
    fi
  register: sentry_node_ids
  delegate_to: localhost
  loop: "{{ groups['all'] | select('match', '^sentry-.*') | list }}"
  changed_when: false
  failed_when: false
  tags: ['config', 'peers']

# ------------------------------------------
# 构建 persistent_peers 列表
# ------------------------------------------
- name: 构建 persistent_peers 列表（验证者）
  set_fact:
    peer_list: []
  tags: ['config', 'peers']

- name: 添加 validator 对等节点
  set_fact:
    peer_list: "{{ peer_list + [item.stdout + '@' + hostvars[item.item]['ansible_host'] + ':26656'] }}"
  loop: "{{ validator_node_ids.results }}"
  when:
    - item.stdout is defined
    - item.stdout != ""
    - item.item != (node_type + '-' + node_index|string)
  tags: ['config', 'peers']

- name: 添加 sentry 对等节点（如果当前是 sentry）
  set_fact:
    peer_list: "{{ peer_list + [item.stdout + '@' + hostvars[item.item]['ansible_host'] + ':26656'] }}"
  loop: "{{ sentry_node_ids.results }}"
  when:
    - node_type == 'sentry'
    - item.stdout is defined
    - item.stdout != ""
    - item.item != (node_type + '-' + node_index|string)
  tags: ['config', 'peers']

- name: 生成 persistent_peers 字符串
  set_fact:
    persistent_peers: "{{ peer_list | join(',') }}"
  tags: ['config', 'peers']

- name: 显示 persistent_peers 配置
  debug:
    msg: |
      当前节点: {{ node_type }}-{{ node_index }}
      连接到: {{ peer_list | length }} 个对等节点
      persistent_peers: {{ persistent_peers }}
  tags: ['config', 'peers']

# ------------------------------------------
# 更新 config.toml
# ------------------------------------------
- name: 更新 config.toml - persistent_peers
  lineinfile:
    path: "{{ node_home_base }}/config/config.toml"
    regexp: '^persistent_peers\s*='
    line: 'persistent_peers = "{{ persistent_peers }}"'
    backup: no
  tags: ['config', 'peers']

- name: 显示 P2P 连接配置完成
  debug:
    msg: "✓ P2P 连接配置完成"
  tags: ['config', 'peers']

