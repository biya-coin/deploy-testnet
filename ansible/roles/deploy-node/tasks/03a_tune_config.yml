---
# ==========================================
# 任务模块：节点配置文件参数调优
# ==========================================
# 功能：修改 config.toml 和 app.toml 的运行时参数
# ==========================================

- name: 显示配置调优信息
  debug:
    msg: |
      开始调优配置文件参数
      - config.toml: 共识相关参数
      - app.toml: 应用层参数
  tags: ['config', 'tune']

# ------------------------------------------
# 修改 config.toml
# ------------------------------------------
- name: 修改 config.toml - timeout_commit（区块提交超时）
  lineinfile:
    path: "{{ node_home_base }}/config/config.toml"
    regexp: '^timeout_commit\s*='
    line: 'timeout_commit = "{{ timeout_commit | default("1500ms") }}"'
    backup: no
  tags: ['config', 'tune']

- name: 修改 config.toml - 日志级别
  lineinfile:
    path: "{{ node_home_base }}/config/config.toml"
    regexp: '^log_level\s*='
    line: 'log_level = "{{ log_level | default("info") }}"'
    backup: no
  tags: ['config', 'tune']

# ------------------------------------------
# 修改 app.toml
# ------------------------------------------
- name: 修改 app.toml - minimum-gas-prices（最低 Gas 价格）
  lineinfile:
    path: "{{ node_home_base }}/config/app.toml"
    regexp: '^minimum-gas-prices\s*='
    line: 'minimum-gas-prices = "{{ minimum_gas_prices | default("160000000inj") }}"'
    backup: no
  tags: ['config', 'tune']

- name: 修改 app.toml - pruning（数据裁剪策略）
  lineinfile:
    path: "{{ node_home_base }}/config/app.toml"
    regexp: '^pruning\s*='
    line: 'pruning = "{{ pruning | default("default") }}"'
    backup: no
  tags: ['config', 'tune']

- name: 修改 app.toml - min-retain-blocks（最小保留区块）
  lineinfile:
    path: "{{ node_home_base }}/config/app.toml"
    regexp: '^min-retain-blocks\s*='
    line: 'min-retain-blocks = {{ min_retain_blocks | default(10000) }}'
    backup: no
  tags: ['config', 'tune']

- name: 修改 app.toml - indexer（索引器配置，validator 禁用，sentry 启用）
  lineinfile:
    path: "{{ node_home_base }}/config/app.toml"
    regexp: '^indexer\s*='
    line: 'indexer = "{{ "null" if node_type == "validator" else "kv" }}"'
    backup: no
  tags: ['config', 'tune']

- name: 显示配置调优完成
  debug:
    msg: |
      配置参数调优完成:
      - timeout_commit: {{ timeout_commit | default("1500ms") }}
      - minimum-gas-prices: {{ minimum_gas_prices | default("160000000inj") }}
      - pruning: {{ pruning | default("default") }}
      - min-retain-blocks: {{ min_retain_blocks | default(10000) }}
      - indexer: {{ "null" if node_type == "validator" else "kv" }}
  tags: ['config', 'tune']

